name: Release

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: macos-latest
                      target: aarch64-apple-darwin
                      label: macOS-ARM64
                    - platform: macos-latest
                      target: x86_64-apple-darwin
                      label: macOS-Intel
                    - platform: ubuntu-22.04
                      target: x86_64-unknown-linux-gnu
                      label: Linux-x64
                    - platform: windows-latest
                      target: x86_64-pc-windows-msvc
                      label: Windows-x64

        runs-on: ${{ matrix.platform }}
        name: Build (${{ matrix.label }})

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: dtolnay/rust-action/setup@v1
              with:
                  targets: ${{ matrix.target }}

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: pnpm

            # Linux dependencies for Tauri
            - name: Install Linux dependencies
              if: matrix.platform == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    libwebkit2gtk-4.1-dev \
                    libappindicator3-dev \
                    librsvg2-dev \
                    patchelf \
                    libssl-dev \
                    libgtk-3-dev \
                    libsoup-3.0-dev \
                    libjavascriptcoregtk-4.1-dev

            - name: Install frontend dependencies
              run: pnpm install

            - name: Build Tauri app
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tagName: ${{ github.ref_name }}
                  releaseName: "SSH-M ${{ github.ref_name }}"
                  releaseBody: |
                      SSH-M ${{ github.ref_name }}

                      ## 安装说明
                      - **macOS**: 下载 `.dmg` 文件，打开后拖入 Applications。首次打开如提示未验证，右键 → 打开。
                      - **Linux**: 下载 `.deb` 或 `.AppImage` 文件。AppImage 需要 `chmod +x` 后运行。
                      - **Windows**: 下载 `.msi` 安装包运行安装。
                  releaseDraft: true
                  prerelease: false
                  args: --target ${{ matrix.target }}
